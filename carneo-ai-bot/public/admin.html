<!doctype html>
<html lang="sk">
  <head>
    <meta charset="utf-8" />
    <title>Carneo AI ‚Äì prehƒæad konverz√°ci√≠</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Arial, sans-serif;
        background: #f5f5f7;
        color: #111827;
      }
      header {
        padding: 16px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
      }
      header h1 {
        font-size: 20px;
        margin: 0;
      }
      .badge-rating {
        cursor: pointer;
        user-select: none;
      }

      .badge-rating.active {
        background: #111827;
        color: #fff;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #e5e7eb;
        margin-left: 6px;
        gap: 4px;
      }
      .badge.errors {
        background: #fee2e2;
        color: #b91c1c;
      }
      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
        gap: 16px;
        padding: 16px 24px 24px;
      }
      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        padding: 16px 18px;
      }
      .card h2 {
        font-size: 16px;
        margin: 0 0 10px;
      }
      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .filters label {
        font-size: 13px;
        color: #4b5563;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      input,
      select {
        font: inherit;
        padding: 4px 8px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        min-width: 0;
      }
      input:focus,
      select:focus {
        outline: 2px solid #111827;
        outline-offset: 1px;
      }
      button {
        font: inherit;
        border-radius: 999px;
        border: 0;
        padding: 6px 14px;
        cursor: pointer;
        background: #111827;
        color: #fff;
      }
      button:disabled {
        opacity: 0.5;
        cursor: default;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      thead {
        background: #f3f4f6;
      }
      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
      }
      th:first-child,
      td:first-child {
        padding-left: 4px;
      }
      th:last-child,
      td:last-child {
        padding-right: 4px;
      }
      tbody tr {
        cursor: pointer;
      }
      tbody tr:hover {
        background: #f9fafb;
      }
      tbody tr.error-row {
        background: #fef2f2;
      }
      tbody tr.error-row:hover {
        background: #fee2e2;
      }
      .mode-pill {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #dcfce7;
        color: #166534;
      }
      .mode-pill.order {
        background: #e0f2fe;
        color: #075985;
      }
      .mode-pill.tech {
        background: #fee2e2;
        color: #b91c1c;
      }
      .mode-pill.error-tag {
        background: #fee2e2;
        color: #b91c1c;
        margin-left: 4px;
      }
      .mode-pill.rating-good {
        background: #dcfce7;
        color: #15803d;
        margin-left: 4px;
      }
      .mode-pill.rating-bad {
        background: #fee2e2;
        color: #b91c1c;
        margin-left: 4px;
      }
      .detail-meta {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 8px;
      }
      .detail-badge {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #e5e7eb;
        margin-right: 6px;
      }
      .detail-body {
        max-height: 70vh;
        overflow: auto;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 10px 12px;
        background: #f9fafb;
      }
      .message-block {
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #e5e7eb;
      }
      .message-block:last-child {
        border-bottom: 0;
      }
      .msg-meta {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
      }
      .msg-q {
        font-size: 14px;
        margin-bottom: 4px;
      }
      .msg-a {
        font-size: 14px;
        background: #fff;
        border-radius: 8px;
        padding: 6px 8px;
        border: 1px solid #e5e7eb;
      }
      .msg-a img {
        max-width: 100%;
        border-radius: 8px;
        margin: 6px 0;
      }
      .error-box {
        padding: 8px 10px;
        border-radius: 8px;
        background: #fee2e2;
        border: 1px solid #fecaca;
        color: #b91c1c;
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .rating-buttons {
        margin-top: 6px;
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }
      .rating-btn {
        border-radius: 999px;
        border: 0;
        padding: 2px 10px;
        font-size: 12px;
        cursor: pointer;
      }
      .rating-btn.good {
        background: #dcfce7;
        color: #166534;
      }
      .rating-btn.bad {
        background: #fee2e2;
        color: #b91c1c;
      }
      .rating-note {
        font-size: 12px;
        color: #6b7280;
      }
      .muted {
        color: #9ca3af;
        font-size: 13px;
      }
      .quality-stats {
        font-size: 13px;
        margin-bottom: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }
      .stat-chip {
        padding: 4px 8px;
        border-radius: 999px;
        background: #f3f4f6;
      }
      .stat-chip.good {
        background: #dcfce7;
        color: #166534;
      }
      .stat-chip.bad {
        background: #fee2e2;
        color: #b91c1c;
      }
      .stat-chip.rag {
        background: #e0f2fe;
        color: #075985;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Carneo AI ‚Äì prehƒæad konverz√°ci√≠</h1>
      <div>
        <span class="badge">Celkom: <span id="totalCount">0</span></span>
        <span class="badge">product: <span id="productCount">0</span></span>
        <span class="badge">order: <span id="orderCount">0</span></span>
        <span class="badge">tech: <span id="techCount">0</span></span>
        <span class="badge errors">chyby: <span id="errorCount">0</span></span>
        
        <!-- üëçüëé klikateƒæn√© filtre -->
        <span class="badge badge-rating" id="badgeGood">
        üëç good: <span id="goodCount">0</span>
        </span>
        <span class="badge badge-rating" id="badgeBad">
          üëé bad: <span id="badCount">0</span>
        </span>
      </div>
    </header>

    <div class="layout">
      <!-- ƒΩAVO: tabuƒæka + filtre -->
      <section class="card">
        <h2>Zoznam konverz√°ci√≠</h2>
        <div class="filters">
          <label>
            Admin key:
            <input
              id="adminKey"
              type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              style="min-width: 180px"
            />
          </label>
          <label>
            Re≈æim:
            <select id="modeFilter">
              <option value="">(v≈°etko)</option>
              <option value="product">product</option>
              <option value="order">order</option>
              <option value="tech">tech</option>
            </select>
          </label>
          <label>
            Hƒæada≈•:
            <input
              id="searchText"
              type="text"
              placeholder="text v ot√°zke/odpovedi"
              style="min-width: 180px"
            />
          </label>
          <label>
            Limit:
            <select id="limitSelect">
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200" selected>200</option>
              <option value="500">500</option>
            </select>
          </label>
          <label>
            <input type="checkbox" id="errorsOnly" />
            iba chyby
          </label>
          <button id="loadBtn">Naƒç√≠ta≈• logy</button>
          <button id="exportCsvBtn" type="button">Export CSV</button>
        </div>

        <!-- C2: ≈°tatistika kvality (pre aktu√°lny filter) -->
        <div id="qualityStats" class="quality-stats">
          <span class="muted">
            ≈†tatistika kvality sa zobraz√≠ po naƒç√≠tan√≠ logov.
          </span>
        </div>

        <div
          style="
            overflow: auto;
            max-height: 60vh;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
          "
        >
          <table>
            <thead>
              <tr>
                <th>ƒåas</th>
                <th>Session</th>
                <th>Re≈æim</th>
                <th>Ot√°zka</th>
              </tr>
            </thead>
            <tbody id="logsTbody"></tbody>
          </table>
        </div>
        <p class="muted">
          Klikni na riadok pre detail celej konverz√°cie. Hodnotenie üëç/üëé je v
          detaile vpravo.
        </p>
      </section>

      <!-- PRAVO: detail konverz√°cie -->
      <section class="card">
        <h2>Detail konverz√°cie</h2>
        <div id="detailInfo" class="detail-meta">
          Zatiaƒæ nie je vybran√° ≈æiadna konverz√°cia.
        </div>
        <div id="detailBody" class="detail-body">
          <p class="muted">
            Vyber riadok v tabuƒæke vƒæavo ‚Äì tu sa zobraz√≠ cel√° konverz√°cia danej
            session (ot√°zky a odpovede v porad√≠). Pri ka≈ædej odpovedi m√¥≈æe≈°
            klikn√∫≈• na üëç/üëé a ulo≈æi≈• hodnotenie.
          </p>
        </div>
      </section>
    </div>

        <script>
      const adminKeyInput = document.getElementById('adminKey');
      const modeFilter = document.getElementById('modeFilter');
      const searchText = document.getElementById('searchText');
      const limitSelect = document.getElementById('limitSelect');
      const errorsOnly = document.getElementById('errorsOnly');
      const loadBtn = document.getElementById('loadBtn');
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const tbody = document.getElementById('logsTbody');

      const totalCountSpan = document.getElementById('totalCount');
      const productCountSpan = document.getElementById('productCount');
      const orderCountSpan = document.getElementById('orderCount');
      const techCountSpan = document.getElementById('techCount');
      const errorCountSpan = document.getElementById('errorCount');

      const detailInfo = document.getElementById('detailInfo');
      const detailBody = document.getElementById('detailBody');
      const qualityStats = document.getElementById('qualityStats');

      const badgeGood = document.getElementById('badgeGood');
      const badgeBad = document.getElementById('badgeBad');
      const goodCountSpan = document.getElementById('goodCount');
      const badCountSpan = document.getElementById('badCount');

      // aktu√°lne zvolen√Ω filter hodnotenia: '', 'good', 'bad'
      let ratingFilter = '';

      // pln√Ω zoznam z backendu
      let allLogs = [];
      // aktu√°lne zobrazen√© po filtrovan√≠
      let currentLogs = [];

      function escapeHtml(str) {
        return String(str || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function formatTs(ts) {
        if (!ts) return '';
        try {
          const d = new Date(ts);
          return d.toLocaleString('sk-SK');
        } catch {
          return ts;
        }
      }

      function percent(part, total) {
        if (!total) return '0%';
        return Math.round((part / total) * 100) + '%';
      }

      // C2 ‚Äì v√Ωpoƒçet ≈°tatist√≠k KVALITY pre aktu√°lny filter
      function computeStats(logs) {
        const stats = {
          total: logs.length,
          product: 0,
          order: 0,
          tech: 0,
          errors: 0,
          withRating: 0,
          ratingGood: 0,
          ratingBad: 0,
          withRag: 0,
          withoutRag: 0,
          genericAnswers: 0
        };

        logs.forEach((entry) => {
          const mode = entry.effectiveMode || entry.modeFromClient || '';
          if (mode === 'product') stats.product++;
          else if (mode === 'order') stats.order++;
          else if (mode === 'tech') stats.tech++;

          if (entry.error) stats.errors++;

          // RAG ≈°tatistiky (podporujeme star√© aj nov√© pole)
          const ragHits = Array.isArray(entry.ragHits)
            ? entry.ragHits
            : Array.isArray(entry.rag_hits)
            ? entry.rag_hits
            : [];
          if (ragHits.length > 0) stats.withRag++;
          else stats.withoutRag++;

          // manu√°lne hodnotenie üëç / üëé
          if (entry.adminRating === 'good') {
            stats.withRating++;
            stats.ratingGood++;
          } else if (entry.adminRating === 'bad') {
            stats.withRating++;
            stats.ratingBad++;
          }

          // veƒæmi jednoduch√° heuristika "produktov√° odpoveƒè bez linku"
          if (mode === 'product') {
            const ans = entry.answer || '';
            if (ans && !ans.includes('<a href=')) {
              stats.genericAnswers++;
            }
          }
        });

        // badge-y hore
        totalCountSpan.textContent = stats.total;
        productCountSpan.textContent = stats.product;
        orderCountSpan.textContent = stats.order;
        techCountSpan.textContent = stats.tech;
        errorCountSpan.textContent = stats.errors;
        goodCountSpan.textContent = stats.ratingGood;
        badCountSpan.textContent = stats.ratingBad;

        // box so ≈°tatistikou kvality
        if (!stats.total) {
          qualityStats.innerHTML =
            '<span class="muted">≈Ωiadne d√°ta pre aktu√°lny filter.</span>';
          return;
        }

        qualityStats.innerHTML = `
          <span class="stat-chip">
            Riadkov: <b>${stats.total}</b>
          </span>
          <span class="stat-chip rag">
            RAG vyu≈æit√Ω: <b>${stats.withRag}</b> (${percent(
              stats.withRag,
              stats.total
            )})
          </span>
          <span class="stat-chip">
            Ohodnoten√Ωch: <b>${stats.withRating}</b> (${percent(
              stats.withRating,
              stats.total
            )})
          </span>
          <span class="stat-chip good">
            üëç good: <b>${stats.ratingGood}</b>
          </span>
          <span class="stat-chip bad">
            üëé bad: <b>${stats.ratingBad}</b>
          </span>
          <span class="stat-chip">
            Produktov√© bez linku: <b>${stats.genericAnswers}</b>
          </span>
        `;
      }

      // vizu√°lne zv√Ωraznenie akt√≠vneho rating filtra
      function updateRatingBadges() {
        badgeGood.classList.toggle('active', ratingFilter === 'good');
        badgeBad.classList.toggle('active', ratingFilter === 'bad');
      }

      // klikateƒæn√© badge-y üëç / üëé (C3 filter)
      badgeGood.addEventListener('click', () => {
        ratingFilter = ratingFilter === 'good' ? '' : 'good';
        updateRatingBadges();
        applyFilters();
      });

      badgeBad.addEventListener('click', () => {
        ratingFilter = ratingFilter === 'bad' ? '' : 'bad';
        updateRatingBadges();
        applyFilters();
      });

      function renderTable(logs) {
        tbody.innerHTML = '';
        logs.forEach((entry) => {
          const tr = document.createElement('tr');

          if (entry.error) {
            tr.classList.add('error-row');
          }

          const mode = entry.effectiveMode || entry.modeFromClient || '';

          const hasErrorTag = entry.error
            ? '<span class="mode-pill error-tag">error</span>'
            : '';

          const ratingTag =
            entry.adminRating === 'good'
              ? '<span class="mode-pill rating-good">üëç</span>'
              : entry.adminRating === 'bad'
              ? '<span class="mode-pill rating-bad">üëé</span>'
              : '';

          tr.innerHTML = `
            <td>${formatTs(entry.ts)}</td>
            <td>${escapeHtml(entry.sessionId || '')}</td>
            <td>
              <span class="mode-pill ${
                mode === 'order'
                  ? 'order'
                  : mode === 'tech'
                  ? 'tech'
                  : ''
              }">${mode || '-'}</span>
              ${hasErrorTag}
              ${ratingTag}
            </td>
            <td title="${escapeHtml(entry.question || '')}">
              ${escapeHtml(entry.question || '').slice(0, 120)}${
                (entry.question || '').length > 120 ? '‚Ä¶' : ''
              }
            </td>
          `;

          tr.addEventListener('click', () => showDetail(entry));
          tbody.appendChild(tr);
        });
      }

      function showDetail(entry) {
        if (!entry) return;

        const sessionId = entry.sessionId;
        const allForSession = currentLogs
          .filter((e) => e.sessionId === sessionId)
          .sort((a, b) => (a.ts > b.ts ? 1 : -1));

        detailInfo.innerHTML = `
          Session: <b>${escapeHtml(sessionId || '')}</b>
          <span class="detail-badge">poƒçet krokov: ${
            allForSession.length
          }</span>
        `;

        if (!allForSession.length) {
          detailBody.innerHTML =
            '<p class="muted">Pre t√∫to session nie s√∫ ≈æiadne z√°znamy.</p>';
          return;
        }

        detailBody.innerHTML = allForSession
          .map((msg, idx) => {
            const mode = msg.effectiveMode || msg.modeFromClient || '';
            const isError = !!msg.error;

            const ratingLabel =
              msg.adminRating === 'good'
                ? '<span class="mode-pill rating-good">üëç good</span>'
                : msg.adminRating === 'bad'
                ? '<span class="mode-pill rating-bad">üëé bad</span>'
                : '';

            const note =
              msg.adminNote && msg.adminNote.trim()
                ? `<div class="rating-note">Pozn√°mka: ${escapeHtml(
                    msg.adminNote
                  )}</div>`
                : '';

            const answerHtml = isError
              ? `<div class="error-box"><strong>‚ö†Ô∏è Chyba:</strong><br>${escapeHtml(
                  msg.error
                )}</div>`
              : `<div class="msg-a">
                  <strong>ü§ñ Odpoveƒè:</strong><br>
                  ${msg.answer || '<span class="muted">(bez odpovede)</span>'}
                </div>`;

            const ratingControls = !isError
              ? `
              <div class="rating-buttons">
                <button
                  type="button"
                  class="rating-btn good"
                  onclick="rateMessage('${escapeHtml(
                    msg.sessionId || ''
                  )}','${escapeHtml(msg.ts || '')}','good')"
                >
                  üëç good
                </button>
                <button
                  type="button"
                  class="rating-btn bad"
                  onclick="rateMessage('${escapeHtml(
                    msg.sessionId || ''
                  )}','${escapeHtml(msg.ts || '')}','bad')"
                >
                  üëé bad
                </button>
                ${ratingLabel}
                ${note}
              </div>
            `
              : ratingLabel
              ? `<div class="rating-buttons">${ratingLabel}${note}</div>`
              : '';

            const ragHits = Array.isArray(msg.ragHits)
              ? msg.ragHits
              : Array.isArray(msg.rag_hits)
              ? msg.rag_hits
              : [];
            const ragInfo =
              ragHits.length > 0
                ? ` ‚Ä¢ RAG: ${ragHits.length} hitov`
                : ' ‚Ä¢ RAG: 0';

            return `
            <div class="message-block">
              <div class="msg-meta">
                #${idx + 1} ‚Ä¢ ${formatTs(msg.ts)} ‚Ä¢ re≈æim: ${
              mode || '-'
            } ‚Ä¢ domain: ${msg.domain || '-'}${ragInfo}
              </div>
              <div class="msg-q">
                <strong>üßë Ot√°zka:</strong> ${escapeHtml(msg.question || '')}
              </div>
              ${answerHtml}
              ${ratingControls}
            </div>
          `;
          })
          .join('');
      }

      function applyFilters() {
        const mode = modeFilter.value;
        const search = searchText.value.trim().toLowerCase();
        const onlyErrors = errorsOnly.checked;

        currentLogs = allLogs.filter((entry) => {
          if (mode) {
            const eff = entry.effectiveMode || entry.modeFromClient || '';
            if (eff !== mode) return false;
          }
          if (onlyErrors && !entry.error) return false;

          if (ratingFilter) {
            if (entry.adminRating !== ratingFilter) return false;
          }

          if (search) {
            const blob = `${entry.question || ''}\n${
              entry.answer || ''
            }\n${entry.error || ''}`.toLowerCase();
            if (!blob.includes(search)) return false;
          }
          return true;
        });

        computeStats(currentLogs);
        renderTable(currentLogs);

        detailInfo.textContent =
          'Klikni na riadok v tabuƒæke vƒæavo pre zobrazenie detailu.';
        detailBody.innerHTML =
          '<p class="muted">≈Ωiadna konverz√°cia nie je vybran√°.</p>';
      }

      async function loadLogs() {
        const key = adminKeyInput.value.trim();
        if (!key) {
          alert('Zadaj admin key.');
          return;
        }

        loadBtn.disabled = true;
        loadBtn.textContent = 'Naƒç√≠tavam...';

        try {
          const params = new URLSearchParams();
          params.set('adminKey', key);
          const mode = modeFilter.value;
          const search = searchText.value.trim();
          const limit = limitSelect.value;

          if (mode) params.set('mode', mode);
          if (search) params.set('search', search);
          if (limit) params.set('limit', limit);

          const resp = await fetch('/api/admin/chat-logs?' + params.toString());
          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('HTTP ' + resp.status + ': ' + txt);
          }
          const data = await resp.json();
          allLogs = Array.isArray(data) ? data : [];

          applyFilters();
        } catch (err) {
          console.error(err);
          alert('Chyba pri naƒç√≠tan√≠ logov: ' + err.message);
        } finally {
          loadBtn.disabled = false;
          loadBtn.textContent = 'Naƒç√≠ta≈• logy';
        }
      }

      // C3 ‚Äì volanie /api/admin/rate z detailu
      async function rateMessage(sessionId, ts, rating) {
        const adminKey = adminKeyInput.value.trim();
        if (!adminKey) {
          alert('Zadaj admin key (hore vƒæavo), aby bolo mo≈æn√© ulo≈æi≈• hodnotenie.');
          return;
        }

        if (rating !== 'good' && rating !== 'bad') {
          alert('Neplatn√Ω typ hodnotenia.');
          return;
        }

        const note = window.prompt('Pozn√°mka k hodnoteniu (voliteƒæn√©):', '') || '';

        try {
          const resp = await fetch('/api/admin/rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              adminKey,
              sessionId,
              ts,
              rating,
              note
            })
          });

          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error('HTTP ' + resp.status + ': ' + txt);
          }

          await loadLogs();
        } catch (err) {
          console.error('rate error', err);
          alert('Chyba pri ukladan√≠ hodnotenia: ' + err.message);
        }
      }

      // spr√≠stupn√≠me funkciu pre inline onclick
      window.rateMessage = rateMessage;

      // C4 ‚Äì export do CSV (aktu√°lny filter = currentLogs)
      function exportCurrentToCsv() {
        if (!currentLogs.length) {
          alert('Nie je ƒço exportova≈• ‚Äì najprv naƒç√≠taj logy.');
          return;
        }

        // ADMIN ‚Äì manu√°lne spustenie importu support e-mailov do tech knowledge
app.post('/api/admin/import-support-emails', async (req, res) => {
  try {
    const body = req.body || {};
    const keyFromBody = body.adminKey as string | undefined;
    const keyFromQuery = req.query.adminKey as string | undefined;
    const providedKey = keyFromBody || keyFromQuery;

    if (!ADMIN_KEY || providedKey !== ADMIN_KEY) {
      return res.status(403).json({ error: 'Forbidden' });
    }

    const daysRaw = (body.days ?? req.query.days ?? '1').toString();
    const days = Math.max(1, parseInt(daysRaw, 10) || 1);

    const result = await importSupportEmails({ days });

    res.json({
      ok: true,
      ...result
    });
  } catch (err: any) {
    console.error('import-support-emails error:', err);
    res.status(500).json({
      ok: false,
      error: err?.message || 'Server error'
    });
  }
});

        const header = [
          'ts',
          'sessionId',
          'effectiveMode',
          'modeFromClient',
          'domain',
          'question',
          'answer',
          'error',
          'adminRating',
          'adminNote',
          'ragHitsCount'
        ];

        const rows = currentLogs.map((e) => {
          const ragHits = Array.isArray(e.ragHits)
            ? e.ragHits
            : Array.isArray(e.rag_hits)
            ? e.rag_hits
            : [];
          const vals = [
            e.ts || '',
            e.sessionId || '',
            e.effectiveMode || '',
            e.modeFromClient || '',
            e.domain || '',
            (e.question || '').replace(/\s+/g, ' ').trim(),
            (e.answer || '').replace(/\s+/g, ' ').trim(),
            (e.error || '').replace(/\s+/g, ' ').trim(),
            e.adminRating || '',
            (e.adminNote || '').replace(/\s+/g, ' ').trim(),
            String(ragHits.length || 0)
          ];
          return vals
            .map((v) => {
              const s = String(v);
              if (s.includes(',') || s.includes('"') || s.includes('\n')) {
                return '"' + s.replace(/"/g, '""') + '"';
              }
              return s;
            })
            .join(',');
        });

        const csv = [header.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const stamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
        a.download = `carneo-chatlogs-${stamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      loadBtn.addEventListener('click', loadLogs);
      exportCsvBtn.addEventListener('click', exportCurrentToCsv);
      searchText.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') loadLogs();
      });
      modeFilter.addEventListener('change', applyFilters);
      errorsOnly.addEventListener('change', applyFilters);
    </script>
  </body>
</html>
