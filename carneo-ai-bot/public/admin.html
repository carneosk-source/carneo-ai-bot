<!doctype html>
<html lang="sk">
  <head>
    <meta charset="utf-8" />
    <title>Carneo AI – Admin logy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Arial, sans-serif;
        margin: 0;
        padding: 16px;
        background: #f3f4f6;
        color: #111827;
      }
      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
      }
      input,
      select {
        padding: 6px 8px;
        font-size: 13px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
      }
      button {
        padding: 6px 10px;
        font-size: 13px;
        border-radius: 6px;
        border: 0;
        background: #111827;
        color: #fff;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: default;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        background: #fff;
      }
      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f9fafb;
        font-weight: 600;
      }
      tr:hover {
        background: #f3f4f6;
        cursor: pointer;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 999px;
        font-size: 11px;
        background: #e5e7eb;
      }
      .badge.product {
        background: #dcfce7;
      }
      .badge.order {
        background: #dbeafe;
      }
      .badge.tech {
        background: #fee2e2;
      }
      #detail {
        margin-top: 16px;
        padding: 12px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        font-size: 13px;
        white-space: pre-wrap;
      }
      .stats {
        margin-bottom: 12px;
        font-size: 13px;
      }
      .stats span {
        margin-right: 12px;
      }
      code {
        background: #f3f4f6;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Carneo AI – prehľad konverzácií</h1>

    <div class="stats" id="stats"></div>

    <div class="toolbar">
      <label>
        Admin key:
        <input id="adminKey" type="password" placeholder="ADMIN_KEY" />
      </label>
      <label>
        Režim:
        <select id="modeFilter">
          <option value="">(všetko)</option>
          <option value="product">product</option>
          <option value="order">order</option>
          <option value="tech">tech</option>
        </select>
      </label>
      <label>
        Hľadať:
        <input
          id="searchQ"
          type="text"
          placeholder="text v otázke/odpovedi"
        />
      </label>
      <label>
        Limit:
        <input id="limit" type="number" value="200" min="10" max="500" />
      </label>
      <button id="loadBtn">Načítať logy</button>
    </div>

    <table id="logsTable">
      <thead>
        <tr>
          <th>Čas</th>
          <th>Session</th>
          <th>Režim</th>
          <th>Otázka</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="detail">Klikni na riadok pre detail otázky a odpovede.</div>

    <script>
      const statsEl = document.getElementById('stats');
      const adminKeyInput = document.getElementById('adminKey');
      const modeFilter = document.getElementById('modeFilter');
      const searchQ = document.getElementById('searchQ');
      const limitInput = document.getElementById('limit');
      const loadBtn = document.getElementById('loadBtn');
      const tbody = document.querySelector('#logsTable tbody');
      const detail = document.getElementById('detail');

      // ak je key v URL, predvyplň
      const urlParams = new URLSearchParams(window.location.search);
      const keyFromUrl = urlParams.get('key');
      if (keyFromUrl) {
        adminKeyInput.value = keyFromUrl;
      }

      function badge(mode) {
        const span = document.createElement('span');
        span.className = 'badge ' + (mode || '');
        span.textContent = mode || 'unknown';
        return span;
      }

      function fmtTime(ts) {
        try {
          const d = new Date(ts);
          return (
            d.toLocaleDateString() + ' ' + d.toLocaleTimeString().slice(0, 8)
          );
        } catch {
          return ts;
        }
      }

      async function loadStats(key) {
        try {
          const res = await fetch(
            '/api/admin/stats?key=' + encodeURIComponent(key)
          );
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          let html = '';
          html += '<span>Celkom konverzácií: <b>' + (data.total || 0) + '</b></span>';
          if (data.byMode) {
            for (const m of Object.keys(data.byMode)) {
              html +=
                '<span>' +
                m +
                ': <b>' +
                data.byMode[m] +
                '</b></span>';
            }
          }
          statsEl.innerHTML = html;
        } catch (e) {
          statsEl.innerHTML = '<span style="color:#b91c1c">Štatistiky sa nepodarilo načítať.</span>';
          console.error(e);
        }
      }

      async function loadLogs() {
        const key = adminKeyInput.value.trim();
        if (!key) {
          alert('Vyplň ADMIN_KEY.');
          return;
        }

        loadBtn.disabled = true;
        loadBtn.textContent = 'Načítavam...';

        const params = new URLSearchParams();
        params.set('key', key);
        const modeVal = modeFilter.value;
        const qVal = searchQ.value.trim();
        const limitVal = limitInput.value || '200';
        params.set('limit', limitVal);
        if (modeVal) params.set('mode', modeVal);
        if (qVal) params.set('q', qVal);

        try {
          const res = await fetch('/api/admin/logs?' + params.toString());
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          const rows = await res.json();
          tbody.innerHTML = '';

          rows.forEach((row, idx) => {
            const tr = document.createElement('tr');

            const tdTime = document.createElement('td');
            tdTime.textContent = fmtTime(row.ts);
            tr.appendChild(tdTime);

            const tdSess = document.createElement('td');
            tdSess.textContent = row.sessionId || '';
            tr.appendChild(tdSess);

            const tdMode = document.createElement('td');
            tdMode.appendChild(badge(row.effectiveMode || row.modeFromClient));
            tr.appendChild(tdMode);

            const tdQ = document.createElement('td');
            tdQ.textContent = row.question || '';
            tr.appendChild(tdQ);

            tr.onclick = () => {
              detail.innerHTML =
                '<b>Čas:</b> ' +
                fmtTime(row.ts) +
                '\n<b>Session:</b> ' +
                (row.sessionId || '') +
                '\n<b>Režim:</b> ' +
                (row.effectiveMode || row.modeFromClient || 'unknown') +
                '\n\n<b>Otázka:</b>\n' +
                (row.question || '') +
                '\n\n<b>Odpoveď:</b>\n' +
                (row.answer || '') +
                '\n\n<b>RAG hity:</b>\n' +
                JSON.stringify(row.ragHits || [], null, 2);
            };

            tbody.appendChild(tr);
          });

          // štatistiky
          loadStats(key);
        } catch (e) {
          console.error(e);
          alert('Chyba pri načítaní logov – pozri konzolu.');
        } finally {
          loadBtn.disabled = false;
          loadBtn.textContent = 'Načítať logy';
        }
      }

      loadBtn.addEventListener('click', loadLogs);
    </script>
  </body>
</html>
